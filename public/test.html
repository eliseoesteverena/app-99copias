<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test SQL Functions - Supabase</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }

    h1 {
      color: #333;
      margin-bottom: 20px;
      font-size: 24px;
    }

    h2 {
      color: #555;
      margin-bottom: 15px;
      font-size: 18px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      color: #555;
      font-weight: 500;
      font-size: 14px;
    }

    input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    input:focus {
      outline: none;
      border-color: #667eea;
    }

    button {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 10px;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5568d3;
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: #4caf50;
      color: white;
    }

    .btn-secondary:hover {
      background: #45a049;
    }

    .btn-danger {
      background: #f44336;
      color: white;
    }

    .btn-danger:hover {
      background: #da190b;
    }

    .status {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      font-size: 14px;
    }

    .status.info {
      background: #e3f2fd;
      color: #1976d2;
      border-left: 4px solid #1976d2;
    }

    .status.success {
      background: #e8f5e9;
      color: #388e3c;
      border-left: 4px solid #4caf50;
    }

    .status.error {
      background: #ffebee;
      color: #c62828;
      border-left: 4px solid #f44336;
    }

    .result-box {
      background: #f5f5f5;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 300px;
      overflow-y: auto;
    }

    .hidden {
      display: none;
    }

    .user-info {
      background: #f0f4ff;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .user-info p {
      margin: 5px 0;
      font-size: 14px;
      color: #333;
    }

    .user-info strong {
      color: #667eea;
    }

    .test-buttons {
      display: grid;
      gap: 10px;
      margin-top: 15px;
    }
  </style>
</head>
<body>
  <div class="container">
    
    <!-- SecciÃ³n de Login -->
    <div class="card" id="loginSection">
      <h1>ğŸ” Test de Funciones SQL</h1>
      <div class="status info">
        Primero debes autenticarte para poder ejecutar las funciones SQL
      </div>

      <form id="loginForm">
        <div class="form-group">
          <label for="email">Email</label>
          <input type="email" id="email" name="email" required 
                 placeholder="tu@email.com">
        </div>
        
        <div class="form-group">
          <label for="password">ContraseÃ±a</label>
          <input type="password" id="password" name="password" required 
                 placeholder="Tu contraseÃ±a">
        </div>
        
        <button type="submit" class="btn-primary">Iniciar SesiÃ³n</button>
      </form>

      <div id="loginError" class="status error hidden"></div>
    </div>

    <!-- SecciÃ³n de Tests (oculta hasta login) -->
    <div class="card hidden" id="testSection">
      <h1>âœ… SesiÃ³n Activa</h1>
      
      <div class="user-info">
        <p><strong>Email:</strong> <span id="userEmail">-</span></p>
        <p><strong>User ID:</strong> <span id="userId">-</span></p>
      </div>

      <h2>Ejecutar Funciones SQL</h2>
      
      <div class="test-buttons">
        <button class="btn-secondary" onclick="testGetUserGrupoId()">
          ğŸ” SELECT get_user_grupo_id()
        </button>
        
        <button class="btn-secondary" onclick="testIsUserAdmin()">
          ğŸ‘¤ SELECT is_user_admin()
        </button>
        
        <button class="btn-secondary" onclick="testBothFunctions()">
          ğŸš€ Ejecutar Ambas Funciones
        </button>
      </div>

      <div id="testResults" class="hidden">
        <h2 style="margin-top: 20px;">Resultados:</h2>
        <div class="result-box" id="resultsOutput"></div>
      </div>

      <button class="btn-danger" onclick="logout()" style="margin-top: 20px;">
        Cerrar SesiÃ³n
      </button>
    </div>

    <!-- SecciÃ³n de Estado de ConexiÃ³n -->
    <div class="card">
      <h2>Estado de ConexiÃ³n</h2>
      <div id="connectionStatus" class="status info">
        Inicializando...
      </div>
    </div>

  </div>

  <!-- Supabase CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
  
  <script>
    // ============================================
    // CONFIGURACIÃ“N - REEMPLAZA CON TUS CREDENCIALES
    // ============================================
    const SUPABASE_URL = 'https://vkthaoiurwuzuztpvuyl.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZrdGhhb2l1cnd1enV6dHB2dXlsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwODM3MDksImV4cCI6MjA4MjY1OTcwOX0.GfQWCwW4I_PeHijgafPhBmBAlS2lqT8aw9UaIY8TdXY';

    // Variables globales
    let supabase;
    let currentUser = null;

    // ============================================
    // INICIALIZACIÃ“N
    // ============================================
    function initSupabase() {
      const statusDiv = document.getElementById('connectionStatus');
      
      try {
        if (typeof window.supabase === 'undefined') {
          throw new Error('Supabase CDN no cargÃ³');
        }

        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        statusDiv.className = 'status success';
        statusDiv.textContent = 'âœ… ConexiÃ³n a Supabase establecida';
        
        // Verificar si ya hay una sesiÃ³n activa
        checkExistingSession();
        
      } catch (error) {
        statusDiv.className = 'status error';
        statusDiv.textContent = 'âŒ Error: ' + error.message;
        console.error('Error inicializando Supabase:', error);
      }
    }

    // Verificar sesiÃ³n existente
    async function checkExistingSession() {
      try {
        const { data: { session } } = await supabase.auth.getSession();
        
        if (session) {
          currentUser = session.user;
          showTestSection();
        }
      } catch (error) {
        console.error('Error verificando sesiÃ³n:', error);
      }
    }

    // ============================================
    // AUTENTICACIÃ“N
    // ============================================
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const errorDiv = document.getElementById('loginError');
      
      errorDiv.classList.add('hidden');
      
      try {
        const { data, error } = await supabase.auth.signInWithPassword({
          email: email,
          password: password
        });
        
        if (error) throw error;
        
        currentUser = data.user;
        showTestSection();
        
      } catch (error) {
        errorDiv.textContent = 'âŒ Error: ' + error.message;
        errorDiv.classList.remove('hidden');
        console.error('Error en login:', error);
      }
    });

    function showTestSection() {
      document.getElementById('loginSection').classList.add('hidden');
      document.getElementById('testSection').classList.remove('hidden');
      
      document.getElementById('userEmail').textContent = currentUser.email;
      document.getElementById('userId').textContent = currentUser.id;
    }

    async function logout() {
      try {
        await supabase.auth.signOut();
        currentUser = null;
        
        document.getElementById('loginSection').classList.remove('hidden');
        document.getElementById('testSection').classList.add('hidden');
        document.getElementById('testResults').classList.add('hidden');
        
        document.getElementById('loginForm').reset();
        
      } catch (error) {
        console.error('Error al cerrar sesiÃ³n:', error);
        alert('Error al cerrar sesiÃ³n: ' + error.message);
      }
    }

    // ============================================
    // FUNCIONES DE TEST SQL
    // ============================================
    
    async function testGetUserGrupoId() {
      const output = document.getElementById('resultsOutput');
      const resultsDiv = document.getElementById('testResults');
      
      output.textContent = 'â³ Ejecutando get_user_grupo_id()...\n\n';
      resultsDiv.classList.remove('hidden');
      
      try {
        // Ejecutar funciÃ³n SQL usando RPC
        const { data, error } = await supabase.rpc('get_user_grupo_id');
        
        if (error) throw error;
        
        output.textContent += 'âœ… SUCCESS\n\n';
        output.textContent += 'FUNCIÃ“N: get_user_grupo_id()\n';
        output.textContent += 'RESULTADO: ' + JSON.stringify(data, null, 2) + '\n\n';
        output.textContent += 'TIPO: ' + typeof data + '\n';
        output.textContent += 'GRUPO_ID: ' + data;
        
      } catch (error) {
        output.textContent += 'âŒ ERROR\n\n';
        output.textContent += 'MENSAJE: ' + error.message + '\n\n';
        output.textContent += 'DETALLES: ' + JSON.stringify(error, null, 2);
        console.error('Error ejecutando get_user_grupo_id:', error);
      }
    }

    async function testIsUserAdmin() {
      const output = document.getElementById('resultsOutput');
      const resultsDiv = document.getElementById('testResults');
      
      output.textContent = 'â³ Ejecutando is_user_admin()...\n\n';
      resultsDiv.classList.remove('hidden');
      
      try {
        // Ejecutar funciÃ³n SQL usando RPC
        const { data, error } = await supabase.rpc('is_user_admin');
        
        if (error) throw error;
        
        output.textContent += 'âœ… SUCCESS\n\n';
        output.textContent += 'FUNCIÃ“N: is_user_admin()\n';
        output.textContent += 'RESULTADO: ' + JSON.stringify(data, null, 2) + '\n\n';
        output.textContent += 'TIPO: ' + typeof data + '\n';
        output.textContent += 'ES ADMIN: ' + (data ? 'SÃ' : 'NO');
        
      } catch (error) {
        output.textContent += 'âŒ ERROR\n\n';
        output.textContent += 'MENSAJE: ' + error.message + '\n\n';
        output.textContent += 'DETALLES: ' + JSON.stringify(error, null, 2);
        console.error('Error ejecutando is_user_admin:', error);
      }
    }

    async function testBothFunctions() {
      const output = document.getElementById('resultsOutput');
      const resultsDiv = document.getElementById('testResults');
      
      output.textContent = 'â³ Ejecutando ambas funciones...\n\n';
      resultsDiv.classList.remove('hidden');
      
      try {
        // Ejecutar ambas funciones en paralelo
        const [grupoResult, adminResult] = await Promise.all([
          supabase.rpc('get_user_grupo_id'),
          supabase.rpc('is_user_admin')
        ]);
        
        output.textContent = 'âœ… AMBAS FUNCIONES EJECUTADAS\n\n';
        output.textContent += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n';
        
        // Resultado 1: get_user_grupo_id
        output.textContent += 'ğŸ“‹ FUNCIÃ“N: get_user_grupo_id()\n';
        if (grupoResult.error) {
          output.textContent += 'âŒ ERROR: ' + grupoResult.error.message + '\n';
        } else {
          output.textContent += 'âœ… RESULTADO: ' + grupoResult.data + '\n';
          output.textContent += '   Tu grupo_id es: ' + grupoResult.data + '\n';
        }
        
        output.textContent += '\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n';
        
        // Resultado 2: is_user_admin
        output.textContent += 'ğŸ‘¤ FUNCIÃ“N: is_user_admin()\n';
        if (adminResult.error) {
          output.textContent += 'âŒ ERROR: ' + adminResult.error.message + '\n';
        } else {
          output.textContent += 'âœ… RESULTADO: ' + adminResult.data + '\n';
          output.textContent += '   Eres admin: ' + (adminResult.data ? 'SÃ' : 'NO') + '\n';
        }
        
        output.textContent += '\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n';
        output.textContent += 'DATOS COMPLETOS:\n';
        output.textContent += JSON.stringify({
          grupo_id: grupoResult.data,
          is_admin: adminResult.data,
          user_email: currentUser.email,
          user_id: currentUser.id
        }, null, 2);
        
      } catch (error) {
        output.textContent += 'âŒ ERROR GENERAL\n\n';
        output.textContent += 'MENSAJE: ' + error.message + '\n\n';
        output.textContent += 'DETALLES: ' + JSON.stringify(error, null, 2);
        console.error('Error ejecutando funciones:', error);
      }
    }

    // ============================================
    // INICIALIZAR AL CARGAR
    // ============================================
    window.addEventListener('DOMContentLoaded', initSupabase);
  </script>
</body>
</html>