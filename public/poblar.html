<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Poblar Datos de Prueba - POS</title>
<style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:system-ui,-apple-system,sans-serif;padding:20px;background:#f5f5f5}.container{max-width:800px;margin:0 auto;background:white;padding:30px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.1)}h1{margin-bottom:20px;color:#333}button{background:#4CAF50;color:white;border:none;padding:15px 30px;font-size:16px;border-radius:6px;cursor:pointer;margin-bottom:20px;width:100%}button:hover{background:#45a049}button:disabled{background:#ccc;cursor:not-allowed}pre{background:#2d2d2d;color:#00ff00;padding:20px;border-radius:6px;overflow-x:auto;max-height:500px;overflow-y:auto;font-size:12px;line-height:1.5}.status{padding:10px;margin-bottom:20px;border-radius:4px;display:none}.status.success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}.status.error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}.status.show{display:block}</style>
</head>
<body>
<div class="container">
<h1>ğŸ² Poblar Datos de Prueba - POS</h1>
<div id="status" class="status"></div>
<button id="btnPoblar" onclick="poblarDatos()">â–¶ï¸ Ejecutar PoblaciÃ³n de Datos</button>
<pre id="log"></pre>
</div>
<script type="module">
import {supabase} from './config.js';
window.supabase=supabase;
async function log(msg,type='info'){const pre=document.getElementById('log');const timestamp=new Date().toLocaleTimeString();const prefix=type==='error'?'âŒ':type==='success'?'âœ…':'â„¹ï¸';pre.textContent+=`[${timestamp}] ${prefix} ${msg}\n`;pre.scrollTop=pre.scrollHeight}
async function showStatus(msg,type){const status=document.getElementById('status');status.textContent=msg;status.className=`status ${type} show`;setTimeout(()=>status.classList.remove('show'),5000)}
window.poblarDatos=async function(){const btn=document.getElementById('btnPoblar');btn.disabled=true;document.getElementById('log').textContent='';try{await log('Iniciando poblaciÃ³n de datos...','info');const {data:{user}}=await supabase.auth.getUser();if(!user){await log('Error: No hay usuario autenticado','error');await showStatus('Error: Debes estar logueado','error');return}await log(`Usuario autenticado: ${user.email}`);const {data:perfil}=await supabase.from('perfiles').select('grupo_id, name').eq('id',user.id).single();if(!perfil){await log('Error: No se encontrÃ³ perfil de usuario','error');return}const grupoId=perfil.grupo_id;await log(`Grupo ID: ${grupoId}`);await log(`Nombre: ${perfil.name}`);await log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');await log('1ï¸âƒ£ Creando grupos de clientes...');const {data:grupoGeneral}=await supabase.from('grupos_clientes').select('id').eq('codigo','general').eq('grupo_id',grupoId).single();let grupoGeneralId=grupoGeneral?.id;if(!grupoGeneralId){const {data:nuevoGrupo}=await supabase.from('grupos_clientes').insert({nombre:'General',codigo:'general',descripcion:'Clientes generales',grupo_id:grupoId}).select().single();grupoGeneralId=nuevoGrupo.id;await log('âœ“ Grupo "General" creado')}else{await log('âœ“ Grupo "General" ya existe')}const {data:grupoEscuela,error:e1}=await supabase.from('grupos_clientes').insert({nombre:'Escuelas',codigo:'school',descripcion:'Instituciones educativas',color:'#3B82F6',grupo_id:grupoId}).select().single();if(e1&&!e1.message.includes('duplicate'))throw e1;await log('âœ“ Grupo "Escuelas" creado');await log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');await log('2ï¸âƒ£ Creando categorÃ­as...');const {data:cats,error:e2}=await supabase.from('categorias').insert([{nombre:'LibrerÃ­a',descripcion:'ArtÃ­culos de librerÃ­a',color:'#FF6B6B',icono:'ğŸ“š',orden:1,grupo_id:grupoId},{nombre:'TecnologÃ­a',descripcion:'Productos tecnolÃ³gicos',color:'#4ECDC4',icono:'ğŸ’»',orden:2,grupo_id:grupoId}]).select();if(e2)throw e2;await log(`âœ“ ${cats.length} categorÃ­as creadas`);await log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');await log('3ï¸âƒ£ Creando productos...');const {data:prods,error:e3}=await supabase.from('productos').insert([{nombre:'Cuadernos',descripcion:'Cuadernos de diferentes tamaÃ±os',codigo_interno:'PROD-001',grupo_id:grupoId},{nombre:'Pendrives',descripcion:'Memorias USB',codigo_interno:'PROD-002',grupo_id:grupoId}]).select();if(e3)throw e3;await log(`âœ“ ${prods.length} productos creados (variantes default auto-creadas)`);await log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');await log('4ï¸âƒ£ Asociando productos con categorÃ­as...');const {error:e4}=await supabase.from('productos_categorias').insert([{producto_id:prods[0].id,categoria_id:cats[0].id,es_principal:true,grupo_id:grupoId},{producto_id:prods[1].id,categoria_id:cats[1].id,es_principal:true,grupo_id:grupoId}]);if(e4)throw e4;await log('âœ“ Productos asociados a categorÃ­as');await log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');await log('5ï¸âƒ£ Creando variantes adicionales...');const {data:vars}=await supabase.from('variantes').select('id,nombre,producto_id').eq('grupo_id',grupoId);await log(`â†’ Variantes default existentes: ${vars.length}`);const {data:newVars,error:e5}=await supabase.from('variantes').insert([{producto_id:prods[0].id,sku:'CUA-A4-RAY',nombre:'Cuaderno A4 Rayado',precio_base:150.00,stock_actual:100,stock_minimo:10,atributos:{tamano:'A4',tipo:'rayado'},grupo_id:grupoId},{producto_id:prods[0].id,sku:'CUA-A5-CUA',nombre:'Cuaderno A5 Cuadriculado',precio_base:120.00,stock_actual:80,stock_minimo:10,atributos:{tamano:'A5',tipo:'cuadriculado'},grupo_id:grupoId},{producto_id:prods[1].id,sku:'USB-16GB',nombre:'Pendrive 16GB',precio_base:800.00,costo:400.00,stock_actual:50,stock_minimo:5,atributos:{capacidad:'16GB'},grupo_id:grupoId}]).select();if(e5)throw e5;await log(`âœ“ ${newVars.length} variantes adicionales creadas`);await log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');await log('6ï¸âƒ£ Creando reglas de precio...');const varianteCuaderno=newVars[0].id;const {data:reglas,error:e6}=await supabase.from('reglas_precio').insert([{scope:'variant',target_id:varianteCuaderno,grupo_cliente_id:grupoEscuela?.id||null,condiciones:[{type:'quantity',min:20,max:null}],accion:{type:'percent',value:15},acumulable:true,activa:true,prioridad:10,descripcion:'15% descuento escuelas por volumen (20+ unidades)',grupo_id:grupoId},{scope:'global',target_id:null,grupo_cliente_id:null,condiciones:[{type:'payment_method',value:'cash'}],accion:{type:'percent',value:5},acumulable:true,activa:true,prioridad:5,descripcion:'5% descuento por pago en efectivo',grupo_id:grupoId}]).select();if(e6)throw e6;await log(`âœ“ ${reglas.length} reglas de precio creadas`);await log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');await log('7ï¸âƒ£ Creando venta de ejemplo...');const {data:numeroVenta}=await supabase.rpc('generate_numero_venta',{p_grupo_id:grupoId});const {data:venta,error:e7}=await supabase.from('ventas').insert({numero_venta:numeroVenta,cliente_id:null,vendedor_id:user.id,subtotal:300.00,descuento_total:0,total_final:300.00,forma_pago:'cash',detalles_pago:{},estado:'completada',trazabilidad_precio:[],grupo_id:grupoId}).select().single();if(e7)throw e7;await log(`âœ“ Venta creada: ${venta.numero_venta}`);const {error:e8}=await supabase.from('items_venta').insert([{venta_id:venta.id,variante_id:newVars[0].id,cantidad:2,precio_unitario:150.00,precio_base_original:150.00,descuento_aplicado:0,grupo_id:grupoId}]);if(e8)throw e8;await log('âœ“ Items de venta creados (stock actualizado automÃ¡ticamente)');await log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');await log('âœ… POBLACIÃ“N COMPLETADA EXITOSAMENTE','success');await showStatus('âœ… Datos de prueba creados correctamente','success');const {data:resumen}=await supabase.from('variantes').select('id',{count:'exact',head:true}).eq('grupo_id',grupoId);await log(`\nğŸ“Š Resumen:`);await log(`   â€¢ Grupos de clientes: 2`);await log(`   â€¢ CategorÃ­as: 2`);await log(`   â€¢ Productos: 2`);await log(`   â€¢ Variantes: ${resumen||0}`);await log(`   â€¢ Reglas de precio: 2`);await log(`   â€¢ Ventas: 1`);}catch(error){await log(`Error: ${error.message}`,'error');await showStatus(`Error: ${error.message}`,'error');console.error('Error completo:',error)}finally{btn.disabled=false}}
</script>
</body>
</html>