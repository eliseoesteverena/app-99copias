<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dash</title>
<style>body{font-family:monospace;padding:20px}button{padding:10px 20px;font-size:16px;cursor:pointer}pre{background:#f4f4f4;padding:15px;overflow:auto;max-height:80vh}</style>
</head>
<body>
<button onclick="runTests()">Ejecutar Pruebas</button>
<pre id="output"></pre>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
<script src="config.js"></script>
<script>
const output=document.getElementById('output');
function log(msg){output.textContent+=msg+'\n';console.log(msg)}
async function runTests(){
output.textContent='Iniciando pruebas...\n\n';
try{
log('=== PRUEBA 1: RLS y Aislamiento ===');
try{
const {data:counts,error:e1}=await supabaseClient.rpc('ejecutar_sql',{query:"SELECT 'Mis clientes' as tabla, COUNT(*) as total FROM clientes UNION ALL SELECT 'Mis empresas', COUNT(*) FROM empresas UNION ALL SELECT 'Mis trabajos', COUNT(*) FROM trabajos"});
if(e1){
const {data:c1}=await supabaseClient.from('clientes').select('*',{count:'exact',head:true});
const {data:c2}=await supabaseClient.from('empresas').select('*',{count:'exact',head:true});
const {data:c3}=await supabaseClient.from('trabajos').select('*',{count:'exact',head:true});
log('Conteos (via API): Clientes='+c1+', Empresas='+c2+', Trabajos='+c3);
}else{log(JSON.stringify(counts,null,2))}
}catch(err){log('Error conteo: '+err.message)}
try{
const {error:e2}=await supabaseClient.from('clientes').insert({nombre:'Hacker',apellido:'Test',email:'test@hack.com',grupo_id:'00000000-0000-0000-0000-000000000000'});
log('Insertar en otro grupo: '+(e2?'❌ BLOQUEADO (correcto): '+e2.message:'⚠️ PERMITIDO (revisar RLS)'));
}catch(err){log('Error insert: '+err.message)}
try{
const {data:user}=await supabaseClient.auth.getUser();
const {error:e3}=await supabaseClient.from('perfiles').update({rol:'admin'}).eq('id',user.user.id);
log('Cambiar rol: '+(e3?'❌ BLOQUEADO (correcto): '+e3.message:'⚠️ PERMITIDO (revisar RLS)'));
}catch(err){log('Error update rol: '+err.message)}
log('\n=== PRUEBA 2: Vistas ===');
try{
const {data:v1}=await supabaseClient.from('vista_trabajos_completos').select('*').limit(3);
log('vista_trabajos_completos (3 primeros):\n'+JSON.stringify(v1,null,2));
}catch(err){log('Error vista trabajos: '+err.message)}
try{
const {data:v2}=await supabaseClient.from('vista_metricas_grupo').select('*');
log('vista_metricas_grupo:\n'+JSON.stringify(v2,null,2));
}catch(err){log('Error vista metricas: '+err.message)}
log('\n=== PRUEBA 3: Funciones ===');
try{
const {data:t}=await supabaseClient.from('trabajos').select('id').limit(1).single();
if(t){
const {data:r1}=await supabaseClient.rpc('registrar_pago_trabajo',{trabajo_id:t.id,monto:5000});
log('registrar_pago_trabajo:\n'+JSON.stringify(r1,null,2));
}else{log('No hay trabajos para probar')}
}catch(err){log('Error registrar_pago: '+err.message)}
try{
const {data:t}=await supabaseClient.from('trabajos').select('id').limit(1).single();
if(t){
const {data:r2}=await supabaseClient.rpc('cambiar_estado_trabajo',{trabajo_id:t.id,nuevo_estado:'completado'});
log('cambiar_estado_trabajo:\n'+JSON.stringify(r2,null,2));
}
}catch(err){log('Error cambiar_estado: '+err.message)}
try{
const {data:r3}=await supabaseClient.rpc('obtener_trabajos_proximos_vencer',{dias:7});
log('trabajos_proximos_vencer (7 días):\n'+JSON.stringify(r3,null,2));
}catch(err){log('Error proximos_vencer: '+err.message)}
try{
const {data:r4}=await supabaseClient.rpc('obtener_trabajos_vencidos');
log('trabajos_vencidos:\n'+JSON.stringify(r4,null,2));
}catch(err){log('Error vencidos: '+err.message)}
log('\n=== PRUEBA 4: Constraints ===');
try{
const {data:t}=await supabaseClient.from('trabajos').select('id,presupuesto').limit(1).single();
if(t){
const {error:e4}=await supabaseClient.from('trabajos').update({monto_pagado:t.presupuesto+1000}).eq('id',t.id);
log('Pagar más del presupuesto: '+(e4?'❌ BLOQUEADO (correcto): '+e4.message:'⚠️ PERMITIDO (revisar constraint)'));
}
}catch(err){log('Error constraint pago: '+err.message)}
try{
const {data:t}=await supabaseClient.from('trabajos').select('id,presupuesto').eq('estado','en_curso').limit(1).single();
if(t){
const {data:r5}=await supabaseClient.from('trabajos').update({monto_pagado:t.presupuesto}).eq('id',t.id).select();
log('Auto-completar al 100%:\n'+JSON.stringify(r5,null,2));
}else{log('No hay trabajos en_curso para probar')}
}catch(err){log('Error auto-completar: '+err.message)}
log('\n=== PRUEBA 5: Índices (EXPLAIN no disponible via API) ===');
log('Las queries EXPLAIN ANALYZE requieren acceso directo a PostgreSQL');
log('Desde Supabase JS solo podemos verificar que las queries funcionen:');
try{
const {data:user}=await supabaseClient.auth.getUser();
const {data:g}=await supabaseClient.from('perfiles').select('grupo_id').eq('id',user.user.id).single();
const {data:idx}=await supabaseClient.from('trabajos').select('*').eq('grupo_id',g.grupo_id).eq('estado','en_curso').eq('prioridad','alta').order('fecha_entrega');
log('Query con índices (trabajos en_curso alta prioridad): '+idx?.length+' resultados');
}catch(err){log('Error query índices: '+err.message)}
log('\n=== PRUEBA 6: Estadísticas ===');
try{
const {data:s1}=await supabaseClient.rpc('estadisticas_trabajos_por_estado');
log('estadisticas_por_estado:\n'+JSON.stringify(s1,null,2));
}catch(err){log('Error stats estado: '+err.message)}
try{
const {data:s2}=await supabaseClient.rpc('top_clientes_por_trabajos',{limite:5});
log('top_clientes (5):\n'+JSON.stringify(s2,null,2));
}catch(err){log('Error top clientes: '+err.message)}
try{
const {data:s3}=await supabaseClient.rpc('evolucion_ingresos_mensual');
log('evolucion_ingresos:\n'+JSON.stringify(s3,null,2));
}catch(err){log('Error ingresos: '+err.message)}
try{
const {data:s4}=await supabaseClient.rpc('analisis_rentabilidad_por_prioridad');
log('rentabilidad_por_prioridad:\n'+JSON.stringify(s4,null,2));
}catch(err){log('Error rentabilidad: '+err.message)}
log('\n✅ PRUEBAS COMPLETADAS');
}catch(err){log('❌ ERROR GENERAL: '+err.message)}
}
</script>
</body>
</html>